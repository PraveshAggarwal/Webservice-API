<!doctype html>
<html>
  <head>
    <title>Save User</title>
    <link rel="stylesheet" href="output.css">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>

  <body
    class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen flex items-center justify-center p-4"
  >
    <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md">
      <h2 class="text-3xl font-bold text-gray-800 text-center mb-8">
        User Registration
      </h2>

      <form id="userForm" class="space-y-4">
        <input
          type="text"
          placeholder="First Name"
          id="firstName"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
        />
        <input
          type="text"
          placeholder="Last Name"
          id="lastName"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
        />
        <input
          type="text"
          placeholder="Mobile (10 digits)"
          id="mobile"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
        />
        <input
          type="text"
          placeholder="Email"
          id="email"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
        />
        <input
          type="text"
          placeholder="Street"
          id="street"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
        />
        <input
          type="text"
          placeholder="City"
          id="city"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
        />
        <input
          type="text"
          placeholder="State"
          id="state"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
        />
        <input
          type="text"
          placeholder="Country"
          id="country"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
        />

        <input
          type="text"
          placeholder="Login ID (8 chars)"
          id="loginId"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
        />
        <input
          type="password"
          placeholder="Password"
          id="password"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
        />

        <button
          type="button"
          id="saveUserBtn"
          class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 transform hover:scale-105 mt-6"
        >
          Save User
        </button>
      </form>

      <div class="text-center mt-6">
        <a
          href="view.html"
          class="text-blue-600 hover:text-blue-800 font-medium"
          >View All Users</a
        >
        <span class="mx-2">|</span>
        <a
          href="login.html"
          class="text-blue-600 hover:text-blue-800 font-medium"
          >Login</a
        >
      </div>
    </div>

    <script>
      const socket = io();

      function validateForm() {
        const firstName = $("#firstName").val().trim();
        const lastName = $("#lastName").val().trim();
        const mobile = $("#mobile").val().trim();
        const email = $("#email").val().trim();
        const street = $("#street").val().trim();
        const city = $("#city").val().trim();
        const state = $("#state").val().trim();
        const country = $("#country").val().trim();
        const loginId = $("#loginId").val().trim();
        const password = $("#password").val();

        // Name validation
        if (!firstName || !/^[A-Za-z\s]+$/.test(firstName)) {
          alert(
            "First name is required and should only contain letters and spaces",
          );
          return false;
        }
        if (!lastName || !/^[A-Za-z\s]+$/.test(lastName)) {
          alert(
            "Last name is required and should only contain letters and spaces",
          );
          return false;
        }

        // Mobile validation
        if (!mobile || !/^[0-9]{10}$/.test(mobile)) {
          alert("Mobile number must be exactly 10 digits");
          return false;
        }

        // Email validation
        if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
          alert("Please enter a valid email address");
          return false;
        }

        // Address validation
        if (!street || !/^[A-Za-z0-9\s,.-]+$/.test(street)) {
          alert("Street address is required and contains valid characters");
          return false;
        }
        if (!city || !/^[A-Za-z\s]+$/.test(city)) {
          alert("City is required and should only contain letters and spaces");
          return false;
        }
        if (!state || !/^[A-Za-z\s]+$/.test(state)) {
          alert("State is required and should only contain letters and spaces");
          return false;
        }
        if (!country || !/^[A-Za-z\s]+$/.test(country)) {
          alert(
            "Country is required and should only contain letters and spaces",
          );
          return false;
        }

        // Login ID validation
        if (!loginId || !/^[A-Za-z0-9]{8}$/.test(loginId)) {
          alert("Login ID must be exactly 8 alphanumeric characters");
          return false;
        }

        // Password validation
        if (
          !password ||
          !/^(?=.*[a-z])(?=.*[A-Z])(?=.*[\W_]).{6,}$/.test(password)
        ) {
          alert(
            "Password must be at least 6 characters with uppercase, lowercase, and special character",
          );
          return false;
        }

        return true;
      }

      $(document).ready(function() {
        $('#saveUserBtn').on('click', saveUser);
      });

      function saveUser() {
        if (!validateForm()) {
          return;
        }

        const data = {
          firstName: $("#firstName").val().trim(),
          lastName: $("#lastName").val().trim(),
          mobile: $("#mobile").val().trim(),
          email: $("#email").val().trim(),
          address: {
            street: $("#street").val().trim(),
            city: $("#city").val().trim(),
            state: $("#state").val().trim(),
            country: $("#country").val().trim(),
          },
          loginId: $("#loginId").val().trim(),
          password: $("#password").val(),
        };

        $.ajax({
          url: "/api/saveUser",
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify(data),
          timeout: 10000,
          success: function (res) {
            alert(res.message);

            const name = `${data.firstName} ${data.lastName}`;

            localStorage.setItem(
              "chatUser",
              JSON.stringify({ name, email: data.email }),
            );

            window.location.href = `chat.html?name=${encodeURIComponent(
              name,
            )}&email=${encodeURIComponent(data.email)}`;

            $("#userForm")[0].reset();
          },
          error: function (xhr, status, error) {
            let errorMessage = "An error occurred";

            if (xhr.responseJSON) {
              if (xhr.responseJSON.details) {
                errorMessage = xhr.responseJSON.details.join("\n");
              } else {
                errorMessage = xhr.responseJSON.error;
              }
            } else if (status === "timeout") {
              errorMessage =
                "Request timed out. Please check your connection and try again.";
            }

            alert("Error: " + errorMessage);
          },
        });
      }
    </script>
  </body>
</html>
