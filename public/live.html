<!doctype html>
<html>
  <head>
    <title>Live Users</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>
  <body class="bg-gradient-to-br from-purple-50 to-pink-100 min-h-screen p-6">
    <div class="max-w-5xl mx-auto">
      <div class="bg-white rounded-xl shadow-2xl p-8">
        <h2 class="text-3xl font-bold text-gray-800 text-center mb-8">
          Live Users (Connected)
        </h2>

        <ul id="userList" class="divide-y divide-gray-200"></ul>

        <div class="text-center mt-8">
          <a
            href="index.html"
            class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 transform hover:scale-105"
            >Add New User</a
          >
        </div>
      </div>
    </div>

    <div
      id="userModal"
      class="fixed inset-0 bg-black/50 hidden items-center justify-center"
    >
      <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-xl">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-semibold text-gray-800">User Details</h3>
          <button
            id="closeModal"
            class="text-gray-500 hover:text-gray-700 font-bold"
          >
            X
          </button>
        </div>
        <pre
          id="userDetails"
          class="text-sm text-gray-700 whitespace-pre-wrap"
        ></pre>
      </div>
    </div>

    <script>
      const socket = io();

      socket.emit("watch_live_users");

      socket.on("live_users_update", (users) => {
        const items = users.map(
          (u) => `
          <li class="py-3 cursor-pointer hover:bg-gray-50" data-email="${u.email}">
            <div class="font-medium text-gray-800">${u.email}</div>
            <div class="text-sm text-gray-500">Socket: ${u.socketId}</div>
          </li>
        `,
        );
        $("#userList").html(items.join(""));
      });

      $("#userList").on("click", "li", function () {
        const email = $(this).data("email");
        $.ajax({
          url: "/api/getUsers?email=" + encodeURIComponent(email),
          type: "GET",
          success: function (res) {
            $("#userDetails").text(JSON.stringify(res[0], null, 2));
            $("#userModal").removeClass("hidden").addClass("flex");
          },
          error: function (err) {
            alert("Error: " + (err.responseJSON?.error || err.statusText));
          },
        });
      });

      $("#closeModal").on("click", function () {
        $("#userModal").removeClass("flex").addClass("hidden");
      });
    </script>
  </body>
</html>
