<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Chat Room</title>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="chat.css" />
  </head>

  <body>
    <div class="chat-layout">
      <aside class="sidebar">
        <h2>Users</h2>
        <ul id="userStatusList"></ul>
      </aside>

      <main class="chat-container">
        <div class="chat-header">
          <h1>Global Chat</h1>
          <button id="logoutBtn">Logout</button>
        </div>

        <ul id="messages"></ul>

        <div class="input-group">
          <input type="text" id="message" placeholder="Type your message..." />
          <button id="sendBtn">Send</button>
        </div>
      </main>
    </div>

    <script>
      $(document).ready(function () {
        const socket = io();

        // Check if user came from login page
        const params = new URLSearchParams(window.location.search);
        const name = params.get("name");
        const email = params.get("email");

        // Only allow access if user came directly from login with params
        if (!name || !email) {
          alert("Please login to access the chat");
          window.location.replace("welcome.html");
          return;
        }

        // Clear the URL params to prevent reuse
        window.history.replaceState(
          {},
          document.title,
          window.location.pathname,
        );

        // Set a session flag to track active chat session
        sessionStorage.setItem("chatActive", "true");

        // Clear session when user leaves the page (back button, close, navigate away)
        window.addEventListener("beforeunload", function () {
          sessionStorage.removeItem("chatActive");
          localStorage.removeItem("chatUser");
        });

        // Prevent back button from accessing chat page
        window.addEventListener("popstate", function () {
          sessionStorage.removeItem("chatActive");
          localStorage.removeItem("chatUser");
          window.location.replace("welcome.html");
        });

        // Prevent accessing chat page via browser back
        if (sessionStorage.getItem("chatActive") !== "true") {
          sessionStorage.setItem("chatActive", "true");
        }

        socket.emit("join_chat", { name, email });

        let allUsers = [];
        let liveUsers = [];

        function renderUserStatuses() {
          const liveEmails = new Set(liveUsers.map((u) => u.email));
          const items = allUsers.map((u) => {
            const isOnline = liveEmails.has(u.email);
            return `
              <li class="user-row">
                <span class="status-dot ${isOnline ? "online" : "offline"}"></span>
                <span class="user-name">${u.firstName} ${u.lastName}</span>
                <span class="user-state">${isOnline ? "Online" : "Offline"}</span>
              </li>
            `;
          });

          $("#userStatusList").html(items.join(""));
        }

        function fetchUsers() {
          $.get("/api/getUsers", function (data) {
            allUsers = data;
            renderUserStatuses();
          });
        }

        function fetchMessages() {
          $.ajax({
            url: "/api/messages",
            method: "GET",
            success: function (data) {
              data.forEach(addMessageToUI);
              autoScroll();
            },
            error: function (err) {
              console.error("Error fetching messages:", err);
            },
          });
        }

        function addMessageToUI(msg) {
          const isOwnMessage = msg.userEmail === email;
          const deleteBtn = isOwnMessage
            ? `<button class="delete-btn" onclick="deleteMessage('${msg._id}')" title="Delete message">üóëÔ∏è</button>`
            : "";

          $("#messages").append(
            `<li data-id="${msg._id}">
              <span><strong>${msg.user}:</strong> ${msg.message}</span>
              ${deleteBtn}
            </li>`,
          );
          autoScroll();
        }

        function autoScroll() {
          const box = $("#messages");
          box.scrollTop(box.prop("scrollHeight"));
        }

        socket.on("live_users_update", (users) => {
          liveUsers = users;
          renderUserStatuses();
        });

        socket.on("chat_message", function (newMessage) {
          addMessageToUI(newMessage);
        });

        socket.on("message_deleted", function ({ messageId }) {
          $(`li[data-id="${messageId}"]`).remove();
        });

        window.deleteMessage = function (messageId) {
          if (confirm("Delete this message?")) {
            socket.emit("delete_message", { messageId, userEmail: email });
          }
        };

        $("#sendBtn").click(function () {
          const message = $("#message").val().trim();
          if (!message) return;

          socket.emit("chat_message", { user: name, email, message });
          $("#message").val("");
        });

        $("#message").keypress(function (e) {
          if (e.which === 13) {
            $("#sendBtn").click();
          }
        });

        $("#logoutBtn").click(function () {
          socket.emit("logout");
          sessionStorage.removeItem("chatActive");
          localStorage.removeItem("chatUser");
          // Clear browser history and redirect
          window.location.replace("welcome.html");
        });

        fetchUsers();
        fetchMessages();
      });
    </script>
  </body>
</html>
