<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Personal Chat</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="chat.css" />
  </head>

  <body>
    <div class="chat-layout">
      <main class="chat-container">
        <div class="chat-header">
          <h1 id="chatTitle">Personal Chat</h1>
          <div>
            <button onclick="goBack()">Back to Users</button>
            <button id="logoutBtn">Logout</button>
          </div>
        </div>

        <ul id="messages"></ul>

        <div class="input-group">
          <button id="attachBtn" title="Attach file">+</button>
          <input type="text" id="message" placeholder="Type your message..." />
          <button id="sendBtn">Send</button>
        </div>

        <div id="dragOverlay" class="drag-overlay">
          <div class="drag-content">
            <div class="drag-icon">üìé</div>
            <p>Drop files here to send</p>
          </div>
        </div>

        <input
          type="file"
          id="fileInput"
          style="display: none"
          multiple
          accept="image/*,video/*,audio/*,.pdf,.doc,.docx"
        />
      </main>
    </div>

    <script>
      $(document).ready(function () {
        const socket = io();
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        const chatWith = JSON.parse(localStorage.getItem("chatWith"));

        if (!currentUser || !chatWith) {
          window.location.href = "/users.html";
          return;
        }

        document.getElementById("chatTitle").textContent =
          `Chat with ${chatWith.name}`;

        socket.emit("join_personal_chat", {
          user1: currentUser.email,
          user2: chatWith.email,
        });

        async function loadMessages() {
          try {
            const response = await fetch(
              `/api/chat/${currentUser.email}/${chatWith.email}`,
            );
            const chat = await response.json();

            $("#messages").empty();
            if (chat.messages) {
              chat.messages.forEach((msg) => {
                addMessageToUI(msg);
              });
            }
            autoScroll();
          } catch (error) {
            console.error("Error loading messages:", error);
          }
        }

        function addMessageToUI(msg) {
          const isOwnMessage = msg.sender === currentUser.email;
          const messageClass = isOwnMessage ? "own-message" : "other-message";
          const time = new Date(msg.timestamp).toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit",
          });
          const deleteBtn = isOwnMessage
            ? `<button class="delete-btn" onclick="deleteMessage('${msg._id}')" title="Delete">üóëÔ∏è</button>`
            : "";

          let content = "";
          if (msg.messageType === "file") {
            const fileExt = msg.fileName.split(".").pop().toLowerCase();
            const isImage = ["jpg", "jpeg", "png", "gif"].includes(fileExt);

            if (isImage) {
              content = `<img src="${msg.fileUrl}" alt="${msg.fileName}" class="message-image" onclick="window.open('${msg.fileUrl}', '_blank')">`;
            } else {
              content = `<div class="file-attachment" onclick="window.open('${msg.fileUrl}', '_blank')">
                <span class="file-icon">üìé</span>
                <div class="file-info">
                  <div class="file-name">${msg.fileName}</div>
                  <div class="file-size">${formatFileSize(msg.fileSize)}</div>
                </div>
              </div>`;
            }
          } else {
            content = `<div class="message-content">${msg.message}</div>`;
          }

          $("#messages").append(`
            <li class="${messageClass}" data-id="${msg._id || ""}">
              <div class="message-bubble">
                ${content}
                <div class="message-time">${time}</div>
                ${deleteBtn}
              </div>
            </li>
          `);
          autoScroll();
        }

        function formatFileSize(bytes) {
          if (bytes === 0) return "0 Bytes";
          const k = 1024;
          const sizes = ["Bytes", "KB", "MB", "GB"];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return (
            parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i]
          );
        }

        function autoScroll() {
          const box = $("#messages");
          box.scrollTop(box.prop("scrollHeight"));
        }

        socket.on("receive_message", function (message) {
          addMessageToUI(message);
        });

        $("#attachBtn").click(function () {
          $("#fileInput").click();
        });

        $("#fileInput").change(function (e) {
          const files = e.target.files;
          if (files.length > 0) {
            uploadFiles(files);
          }
        });

        // Drag and drop functionality - limited to chat container
        let dragCounter = 0;

        $(".chat-container").on("dragenter", function (e) {
          e.preventDefault();
          dragCounter++;
          $("#dragOverlay").addClass("active");
        });

        $(".chat-container").on("dragleave", function (e) {
          e.preventDefault();
          dragCounter--;
          if (dragCounter === 0) {
            $("#dragOverlay").removeClass("active");
          }
        });

        $(".chat-container").on("dragover", function (e) {
          e.preventDefault();
        });

        $(".chat-container").on("drop", function (e) {
          e.preventDefault();
          dragCounter = 0;
          $("#dragOverlay").removeClass("active");

          const files = e.originalEvent.dataTransfer.files;
          if (files.length > 0) {
            uploadFiles(files);
          }
        });

        window.deleteMessage = function (messageId) {
          if (!messageId) return;
          if (confirm("Delete this message?")) {
            socket.emit("delete_message", {
              messageId,
              userEmail: currentUser.email,
            });
          }
        };

        socket.on("message_deleted", function ({ messageId }) {
          $(`li[data-id="${messageId}"]`).remove();
        });

        function uploadFiles(files) {
          Array.from(files).forEach((file) => {
            const formData = new FormData();
            formData.append("file", file);

            // Show loading message with progress
            const loadingId = "loading-" + Date.now() + Math.random();
            const startTime = Date.now();

            $("#messages").append(`
              <li class="own-message" id="${loadingId}">
                <div class="message-bubble loading-message">
                  <div class="upload-progress">
                    <div class="loading-spinner"></div>
                    <div class="upload-text">Uploading ${file.name}...</div>
                    <div class="progress-bar">
                      <div class="progress-fill"></div>
                    </div>
                  </div>
                  <div class="message-time">uploading</div>
                </div>
              </li>
            `);
            autoScroll();

            // Simulate progress updates for better UX
            let simulatedProgress = 0;
            const progressInterval = setInterval(() => {
              if (simulatedProgress < 90) {
                simulatedProgress += Math.random() * 10;
                $(`#${loadingId} .progress-fill`).css(
                  "width",
                  Math.min(90, simulatedProgress) + "%",
                );
              }
            }, 200);

            $.ajax({
              url: "/api/upload",
              type: "POST",
              data: formData,
              processData: false,
              contentType: false,
              xhr: function () {
                const xhr = new window.XMLHttpRequest();
                xhr.upload.addEventListener(
                  "progress",
                  function (e) {
                    if (e.lengthComputable) {
                      const percent = Math.round((e.loaded / e.total) * 100);
                      clearInterval(progressInterval);
                      $(`#${loadingId} .progress-fill`).css(
                        "width",
                        percent + "%",
                      );
                      $(`#${loadingId} .upload-text`).text(
                        `Uploading ${file.name}... ${percent}%`,
                      );
                    }
                  },
                  false,
                );
                return xhr;
              },
              success: function (response) {
                clearInterval(progressInterval);

                // Remove loading state immediately and forcefully
                const loadingElement = document.getElementById(loadingId);
                if (loadingElement) {
                  loadingElement.remove();
                }

                // Send the file message
                socket.emit("send_message", {
                  sender: currentUser.email,
                  recipient: chatWith.email,
                  fileData: response,
                });
              },
              error: function (xhr) {
                clearInterval(progressInterval);
                $(`#${loadingId}`).addClass("upload-error");
                $(`#${loadingId} .upload-text`).text("Upload failed!");

                setTimeout(() => {
                  $(`#${loadingId}`).fadeOut(300, function () {
                    $(this).remove();
                  });
                  alert(
                    "Upload failed: " +
                      (xhr.responseJSON?.error || "Unknown error"),
                  );
                }, 1000);
              },
            });
          });
        }

        $("#sendBtn").click(function () {
          const message = $("#message").val().trim();
          if (!message) return;

          socket.emit("send_message", {
            sender: currentUser.email,
            recipient: chatWith.email,
            message: message,
          });

          $("#message").val("");
        });

        $("#message").keypress(function (e) {
          if (e.which === 13) {
            $("#sendBtn").click();
          }
        });

        $("#logoutBtn").click(function () {
          localStorage.removeItem("currentUser");
          localStorage.removeItem("chatWith");
          window.location.href = "/login.html";
        });

        window.goBack = function () {
          window.location.href = "/users.html";
        };

        loadMessages();
      });
    </script>
  </body>
</html>
