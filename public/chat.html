<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Chat Room</title>

    <!-- jQuery CDN -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- Socket.IO CDN -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <link rel="stylesheet" href="chat.css" />
  </head>

  <body>
    <div class="chat-container">
      <h1>Chat Room</h1>

      <ul id="messages"></ul>

      <div class="input-group">
        <input type="text" id="username" placeholder="Your name" />
        <input type="text" id="message" placeholder="Type your message..." />
        <button id="sendBtn">Send</button>
      </div>
    </div>

    <script>
      $(document).ready(function () {
        const socket = io("http://localhost:5000", {
          transports: ["websocket", "polling"],
        });

        // Fetch old messages (AJAX)
        function fetchMessages() {
          $.ajax({
            url: "http://localhost:5000/messages",
            method: "GET",
            success: function (data) {
              data.forEach(addMessageToUI);
              autoScroll();
            },
            error: function (err) {
              console.error("Error fetching messages:", err);
            },
          });
        }

        // Add message to UI
        function addMessageToUI(msg) {
          $("#messages").append(
            `<li><strong>${msg.user}:</strong> ${msg.message}</li>`,
          );
          autoScroll();
        }

        // Auto-scroll
        function autoScroll() {
          const box = $("#messages");
          box.scrollTop(box.prop("scrollHeight"));
        }

        // Receive message
        socket.on("message", function (newMessage) {
          addMessageToUI(newMessage);
        });

        // Send message
        $("#sendBtn").click(function () {
          const user = $("#username").val().trim();
          const message = $("#message").val().trim();

          if (!user || !message) return;

          socket.emit("sendMessage", { user, message });
          $("#message").val("");
        });

        // Send on Enter key
        $("#message").keypress(function (e) {
          if (e.which === 13) {
            $("#sendBtn").click();
          }
        });

        // Initial load
        fetchMessages();
      });
    </script>
  </body>
</html>
