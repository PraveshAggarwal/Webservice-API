<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Chat Room</title>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="chat.css" />
  </head>

  <body>
    <div class="chat-layout">
      <aside class="sidebar">
        <h2>Users</h2>
        <ul id="userStatusList"></ul>
      </aside>

      <main class="chat-container">
        <div class="chat-header">
          <h1>Global Chat</h1>
          <button id="logoutBtn">Logout</button>
        </div>

        <ul id="messages"></ul>

        <div class="input-group">
          <input type="text" id="message" placeholder="Type your message..." />
          <button id="sendBtn">Send</button>
        </div>
      </main>
    </div>

    <script>
      $(document).ready(function () {
        const socket = io();

        const params = new URLSearchParams(window.location.search);
        const stored = JSON.parse(localStorage.getItem("chatUser") || "{}");

        const name = params.get("name") || stored.name;
        const email = params.get("email") || stored.email;

        if (!name || !email) {
          window.location.href = "index.html";
          return;
        }

        socket.emit("join_chat", { name, email });
        socket.emit("watch_live_users");

        let allUsers = [];
        let liveUsers = [];

        function renderUserStatuses() {
          const liveEmails = new Set(liveUsers.map((u) => u.email));
          const items = allUsers.map((u) => {
            const isOnline = liveEmails.has(u.email);
            return `
              <li class="user-row">
                <span class="status-dot ${isOnline ? "online" : "offline"}"></span>
                <span class="user-name">${u.firstName} ${u.lastName}</span>
                <span class="user-state">${isOnline ? "Online" : "Offline"}</span>
              </li>
            `;
          });

          $("#userStatusList").html(items.join(""));
        }

        function fetchUsers() {
          $.get("/api/getUsers", function (data) {
            allUsers = data;
            renderUserStatuses();
          });
        }

        function fetchMessages() {
          $.ajax({
            url: "/api/messages",
            method: "GET",
            success: function (data) {
              data.forEach(addMessageToUI);
              autoScroll();
            },
            error: function (err) {
              console.error("Error fetching messages:", err);
            },
          });
        }

        function addMessageToUI(msg) {
          $("#messages").append(
            `<li><strong>${msg.user}:</strong> ${msg.message}</li>`,
          );
          autoScroll();
        }

        function autoScroll() {
          const box = $("#messages");
          box.scrollTop(box.prop("scrollHeight"));
        }

        socket.on("live_users_update", (users) => {
          liveUsers = users;
          renderUserStatuses();
        });

        socket.on("chat_message", function (newMessage) {
          addMessageToUI(newMessage);
        });

        $("#sendBtn").click(function () {
          const message = $("#message").val().trim();
          if (!message) return;

          socket.emit("chat_message", { user: name, email, message });
          $("#message").val("");
        });

        $("#message").keypress(function (e) {
          if (e.which === 13) {
            $("#sendBtn").click();
          }
        });

        $("#logoutBtn").click(function () {
          socket.emit("logout");
          localStorage.removeItem("chatUser");
          window.location.href = "index.html";
        });

        fetchUsers();
        fetchMessages();
      });
    </script>
  </body>
</html>
